import logging

from pythoncommons.file_utils import FileUtils
from pythoncommons.project_utils import ProjectUtils

from yarndevtools.commands.unittestresultaggregator.constants import (
    SummaryMode,
)
from yarndevtools.commands_common import CommandAbs, GSheetArguments, ArgumentParserUtils
from yarndevtools.common.shared_command_utils import CommandType
from yarndevtools.yarn_dev_tools_config import YarnDevToolsConfig

CMD = CommandType.UNIT_TEST_RESULT_AGGREGATOR_DB
LOG = logging.getLogger(__name__)


class DatabaseUnitTestResultAggregator(CommandAbs):
    # TODO yarndevtoolsv2 DB: Gsheet should be a secondary 'DB', all data should be written to mongoDB first
    def __init__(self, args, parser, output_dir: str):
        super().__init__()
        # TODO yarndevtoolsv2 DB: Implement

    @staticmethod
    def create_parser(subparsers):
        parser = subparsers.add_parser(
            CMD.name,
            help="Aggregates unit test results from a Database."
            "Example: "
            "--gsheet "
            "--gsheet-client-secret /Users/snemeth/.secret/dummy.json "
            "--gsheet-spreadsheet 'Failed testcases parsed from emails [generated by script]' "
            "--gsheet-worksheet 'Failed testcases'",
        )

        gsheet_group = GSheetArguments.add_gsheet_arguments(parser)

        gsheet_group.add_argument(
            "--gsheet-compare-with-jira-table",
            dest="gsheet_compare_with_jira_table",
            type=str,
            help="This should be provided if comparison of failed testcases with reported jira table must be performed. "
            "The value is a name to a worksheet, for example 'testcases with jiras'.",
        )

        parser.add_argument(
            "-v",
            "--verbose",
            action="store_true",
            dest="verbose",
            default=None,
            required=False,
            help="More verbose log",
        )

        parser.add_argument(
            "-m",
            "--match-expression",
            required=False,
            # TODO
            type=ArgumentParserUtils.matches_match_expression_pattern,
            nargs="+",
            help="Line matcher expression, this will be converted to a regex. "
            "For example, if expression is org.apache, the regex will be .*org\\.apache\\.* "
            "Only lines in the mail content matching for this expression will be considered as a valid line.",
        )

        parser.add_argument(
            "--abbreviate-testcase-package",
            dest="abbrev_testcase_package",
            type=str,
            help="Whether to abbreviate testcase package names in outputs in order to save screen space. "
            "The specified string will be abbreviated with the starting letters."
            "For example, specifying 'org.apache.hadoop.yarn' will be converted to 'o.a.h.y' "
            "when printing testcase names to any destination.",
        )

        parser.add_argument(
            "--summary-mode",
            dest="summary_mode",
            type=str,
            choices=[sm.value for sm in SummaryMode],
            default=SummaryMode.HTML.value,
            help="Summary file(s) will be written in this mode. Defaults to HTML.",
        )

        # TODO
        parser.add_argument(
            "--aggregate-filters",
            dest="aggregate_filters",
            required=True,
            type=str,
            nargs="+",
            help="Execute some post filters on the email results. "
            "The resulted emails and testcases for each filter will be aggregated to "
            "a separate worksheet with name <WS>_aggregated_<aggregate-filter> where WS is equal to the "
            "value specified by the --gsheet-worksheet argument.",
        )

        exclusive_group = parser.add_mutually_exclusive_group(required=True)
        exclusive_group.add_argument(
            "-p", "--print", action="store_true", dest="do_print", help="Print results to console", required=False
        )
        exclusive_group.add_argument(
            "-g",
            "--gsheet",
            action="store_true",
            dest="gsheet",
            default=False,
            required=False,
            help="Export values to Google sheet. Additional gsheet arguments need to be specified!",
        )

        parser.set_defaults(func=DatabaseUnitTestResultAggregator.execute)

    @staticmethod
    def execute(args, parser=None):
        # TODO implement
        raise NotImplementedError()
        # output_dir = ProjectUtils.get_output_child_dir(CMD.output_dir_name)
        # aggregator = DatabaseUnitTestResultAggregator(args, parser, output_dir)
        # FileUtils.create_symlink_path_dir(
        #     CMD.session_link_name,
        #     aggregator.config.session_dir,
        #     YarnDevToolsConfig.PROJECT_OUT_ROOT,
        # )
        # aggregator.run()

    def run(self):
        # TODO yarndevtoolsv2 DB: implement
        LOG.info(f"Starting DB Unit test result aggregator. Config: \n{str(self.config)}")
        raise NotImplementedError()
        # aggr_results: TestcaseFilterResults = self.filter_query_result_data(query_result, self.testcases_to_jiras)
        # output_manager = UnitTestResultOutputManager(
        #     self.config.session_dir, self.config.console_mode, self.gsheet_wrapper
        # )
        # SummaryGenerator.process_aggregation_results(testcase_filter, query_result, self.config, output_manager)
